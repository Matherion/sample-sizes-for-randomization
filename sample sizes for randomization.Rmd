---
title: "Randomization Results Section"
author: "Gjalt-Jorn Ygram Peters & Stefan Gruijters"
date: "`r format(Sys.time(), '%d %b %Y at %H:%M:%S');`"
output: html_document
---

```{r preparation, echo=FALSE, results="hide", message=FALSE, error=FALSE, cache=FALSE}

################################################################################
################################################################################
### Configure basic settings
################################################################################
################################################################################

########################################################################
### Paths
########################################################################

### Add any relevant paths to this vector. The script will select the
### correct path itself.

basePathVector <- c("B:/Data/research/randomization/sample-sizes-for-randomization",
                    "");

########################################################################
### Set the variables with the paths
########################################################################

### Check which paths exist and set the first existing path in the list
### as the base path
basePath <- basePathVector[sapply(basePathVector, dir.exists)][1];

### Set the additional paths
workingPath <- basePath;
outputPath <- basePath;

########################################################################
### Packages
########################################################################

### For function 'vecTxt' and 'safeRequire'; also loads ggplot2 which
### we'll use for the plots
require('userfriendlyscience', quietly = TRUE);

### For function 'mvrnorm'
require('MASS', quietly = TRUE);

### For functions 'raply' and 'ddply'
require('plyr', quietly = TRUE);

### For functions 'melt' and 'dcast'
require('reshape2', quietly = TRUE)

### For function 'pander'
require('pander', quietly = TRUE)

### For knitting and accessing knitr functions
require('knitr', quietly = TRUE);

### For plotting
require('ggplot2', quietly = TRUE);

########################################################################
### Settings
########################################################################

### Setting default knitting options
knitr::opts_chunk$set(echo=FALSE);
knitr::opts_chunk$set(comment=NA);
knitr::opts_chunk$set(dev="png", 
		  		            dev.args=list(type="cairo"),
			    	          dpi=100);
knitr::opts_chunk$set(fig.width=5);
knitr::opts_chunk$set(fig.height=5);
knitr::opts_chunk$set(cache=TRUE);
knitr::opts_knit$set(eval.after = 'fig.cap');

options(scipen=100);
options(figure_counter = TRUE);
options(table_counter = TRUE);

setFigCapNumbering(figure_counter_str = "Figure %s: ",
                   figureClass = "caption",
                   figureInlineStyle = NULL);
setTabCapNumbering(table_counter_str = ":Table %s: ");

```

The results for a situation with only one nuisance variable are shown in Figure 1 and Table 1. As sample sizes increase and effect sizes decrease, the probability of the nuisance variable differing between groups with a given effect size decreases. Even with only 20 participants (10 in each cell), the probability of one group mean being one standard deviation higher than the other group mean is only 4%. However, in one in three studies with a total sample size of 20, one group's mean is half a standard deviation higher than the other group's mean (a 'moderately large' difference). If smaller differences between groups are already considered problematic, the sample size required to constrain the probability of non-equivalent groups rapidly increases.

If a difference between groups of Cohen's d = .2 or larger is considered problematic, even with a total sample size of 150 participants (75 per cell) still about one fifth of the studies (20%) will in fact be quasi-experiments with respect to this nuisance variable. To get the proportion of studies with non-equivalent groups below 10%, at least `r pwr.randomizationSuccess(.2, .90, 1)` participants are required.

```{r fig.cap="Probability of one nuisance variable differing between groups for Cohen's d's from .2, .3, .4 and .5 for sample sizes from 20-500.", tab.cap="Required sample size to achieve 80%, 90%, 95%, and 99% likelihood of randomization success, assuming only one nuisance variable exists, and With non-equivalence defined as group differences exceeding Cohen's d = .1, .2, .3, .4 and .5." }

  df <- data.frame(x = seq(10, 500, 1),
                   d.2 = 1 - prob.randomizationSuccess(d=.2, n=seq(10, 500, 1), nNuisanceVars = 1),
                   d.3 = 1 - prob.randomizationSuccess(d=.3, n=seq(10, 500, 1), nNuisanceVars = 1),
                   d.4 = 1 - prob.randomizationSuccess(d=.4, n=seq(10, 500, 1), nNuisanceVars = 1),
                   d.5 = 1 - prob.randomizationSuccess(d=.5, n=seq(10, 500, 1), nNuisanceVars = 1));

  ggplot(df, aes(x=x)) +
    geom_ribbon(aes(ymax = 1, ymin=d.2), fill="#008800", alpha=.33) +
    geom_ribbon(aes(ymax = d.2, ymin=d.3), fill="#FFAA00", alpha=.33) +
    geom_ribbon(aes(ymax = d.3, ymin=d.4), fill="#FF9900", alpha=.33) +
    geom_ribbon(aes(ymax = d.4, ymin=d.5), fill="#FF6600", alpha=.33) +
    geom_ribbon(aes(ymax = d.5, ymin=0), fill="#FF3300", alpha=.33) +
    geom_line(aes(y=d.2), color="#FFAA00", size=1) +
    geom_line(aes(y=d.3), color="#FF9900", size=1) +
    geom_line(aes(y=d.4), color="#FF6600", size=1) +
    geom_line(aes(y=d.5), color="#FF3300", size=1) +
    geom_hline(yintercept = .05) +
    geom_vline(xintercept = min(df[df$d.2 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.3 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.4 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.5 <= .05, 'x'])) +
    xlab("Total sample size") +
    ylab("Probability of nonequivalent groups") +
    ggtitle("One potential confounder") +
    coord_cartesian(ylim=c(0,1)) +
    scale_x_continuous(breaks=seq(0, 500, by=100),
                       sec.axis=dup_axis(breaks=c(min(df[df$d.2 <= .05, 'x']),
                                         min(df[df$d.3 <= .05, 'x']),
                                         min(df[df$d.4 <= .05, 'x']),
                                         min(df[df$d.5 <= .05, 'x'])))) +
    theme_bw(base_size = 16);

ggsave(file.path(outputPath, "figure 1 - nonequivalence probability for 1 nuisance variable.png"),
       width = 14,
       height = 8,
       type='cairo-png');

```

Of course, in most situations, assuming that only one nuisance variable exists is almost as naive as assuming that no nuisance variables exist. Therefore, we also computed these probabilities as a function of the number of nuisance variables. For a Cohen's d of .5, these probabilities are shown in Figure 2 and Table 2, and for a Cohen's d of .2, in Figure 3 and Table 3.

```{r fig.cap="Probability of ten nuisance variables differing between groups for Cohen's d's from .2, .3, .4 and .5 for sample sizes from 20-1000."}

  df <- data.frame(x = seq(10, 1000, 1),
                   d.2 = 1 - prob.randomizationSuccess(d=.2, n=seq(10, 1000, 1), nNuisanceVars = 10),
                   d.3 = 1 - prob.randomizationSuccess(d=.3, n=seq(10, 1000, 1), nNuisanceVars = 10),
                   d.4 = 1 - prob.randomizationSuccess(d=.4, n=seq(10, 1000, 1), nNuisanceVars = 10),
                   d.5 = 1 - prob.randomizationSuccess(d=.5, n=seq(10, 1000, 1), nNuisanceVars = 10));

  ggplot(df, aes(x=x)) +
    geom_ribbon(aes(ymax = 1, ymin=d.2), fill="#008800", alpha=.33) +
    geom_ribbon(aes(ymax = d.2, ymin=d.3), fill="#FFAA00", alpha=.33) +
    geom_ribbon(aes(ymax = d.3, ymin=d.4), fill="#FF9900", alpha=.33) +
    geom_ribbon(aes(ymax = d.4, ymin=d.5), fill="#FF6600", alpha=.33) +
    geom_ribbon(aes(ymax = d.5, ymin=0), fill="#FF3300", alpha=.33) +
    geom_line(aes(y=d.2), color="#FFAA00", size=1) +
    geom_line(aes(y=d.3), color="#FF9900", size=1) +
    geom_line(aes(y=d.4), color="#FF6600", size=1) +
    geom_line(aes(y=d.5), color="#FF3300", size=1) +
    geom_hline(yintercept = .05) +
    geom_vline(xintercept = min(df[df$d.2 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.3 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.4 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.5 <= .05, 'x'])) +
    xlab("Total sample size") +
    ylab("Probability of nonequivalent groups") +
    ggtitle("Ten potential confounders") +
    coord_cartesian(ylim=c(0,1)) +
    scale_x_continuous(breaks=seq(0, 1000, by=100),
                       sec.axis=dup_axis(breaks=c(min(df[df$d.2 <= .05, 'x']),
                                         min(df[df$d.3 <= .05, 'x']),
                                         min(df[df$d.4 <= .05, 'x']),
                                         min(df[df$d.5 <= .05, 'x'])))) +
    theme_bw(base_size = 16);

ggsave(file.path(outputPath, "figure 2 - nonequivalence probability for 10 nuisance variables.png"),
       width = 14,
       height = 8,
       type='cairo-png');

```


```{r fig.cap="Probability of one hundred nuisance variables differing between groups for Cohen's d's from .2, .3, .4 and .5 for sample sizes from 20-1000."}

  df <- data.frame(x = seq(10, 1000, 1),
                   d.2 = 1 - prob.randomizationSuccess(d=.2, n=seq(10, 1000, 1), nNuisanceVars = 100),
                   d.3 = 1 - prob.randomizationSuccess(d=.3, n=seq(10, 1000, 1), nNuisanceVars = 100),
                   d.4 = 1 - prob.randomizationSuccess(d=.4, n=seq(10, 1000, 1), nNuisanceVars = 100),
                   d.5 = 1 - prob.randomizationSuccess(d=.5, n=seq(10, 1000, 1), nNuisanceVars = 100));

  ggplot(df, aes(x=x)) +
    geom_ribbon(aes(ymax = 1, ymin=d.2), fill="#008800", alpha=.33) +
    geom_ribbon(aes(ymax = d.2, ymin=d.3), fill="#FFAA00", alpha=.33) +
    geom_ribbon(aes(ymax = d.3, ymin=d.4), fill="#FF9900", alpha=.33) +
    geom_ribbon(aes(ymax = d.4, ymin=d.5), fill="#FF6600", alpha=.33) +
    geom_ribbon(aes(ymax = d.5, ymin=0), fill="#FF3300", alpha=.33) +
    geom_line(aes(y=d.2), color="#FFAA00", size=1) +
    geom_line(aes(y=d.3), color="#FF9900", size=1) +
    geom_line(aes(y=d.4), color="#FF6600", size=1) +
    geom_line(aes(y=d.5), color="#FF3300", size=1) +
    geom_hline(yintercept = .05) +
    #geom_vline(xintercept = min(df[df$d.2 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.3 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.4 <= .05, 'x'])) +
    geom_vline(xintercept = min(df[df$d.5 <= .05, 'x'])) +
    xlab("Total sample size") +
    ylab("Probability of nonequivalent groups") +
    ggtitle("One hundred potential confounders") +
    coord_cartesian(ylim=c(0,1)) +
    scale_x_continuous(breaks=seq(0, 1000, by=100),
                       sec.axis=dup_axis(breaks=c(#min(df[df$d.2 <= .05, 'x']),
                                         min(df[df$d.3 <= .05, 'x']),
                                         min(df[df$d.4 <= .05, 'x']),
                                         min(df[df$d.5 <= .05, 'x'])))) +
    theme_bw(base_size=16);

ggsave(file.path(outputPath, "figure 3 - nonequivalence probability for 100 nuisance variables.png"),
       width = 14,
       height = 8,
       type='cairo-png');


```


```{r}

  if (!file.exists(file.path(basePath, 'rpp_data.csv'))) {
    stop("The file 'rpp_data.csv' is not available. Please visit https://osf.io/fgjvw and download it (see https://osf.io/bhcsf for the codebook).");
  }

  ### Import data
  dat <- getData(file.path(basePath, 'rpp_data.csv'));
  cat("Read", nrow(dat), "studies.");
  
  ### Select two-cell designs
  dat <- dat[grep('^(t\\()|(F\\(1)', dat$Test.statistic..O.), ];
  cat("Selected", nrow(dat), "two-cell designs.");
  
  ### Convenient names for the sample size.
  dat$originalSampleSize <- as.numeric(dat$N..O.);
  dat$replicationSampleSize <- as.numeric(dat$N..R.);

  ### Remove missing values
  dat <- dat[, c('originalSampleSize', 'replicationSampleSize')];
  dat <- na.omit(dat);
  cat("Retained samples after removing missing values:", nrow(dat));
  
  ### Remove huge sample sizes
  cat("Removing", sum(dat$replicationSampleSize >= 1000),
      "samples of over 1000 participants,");
  dat <- dat[dat$replicationSampleSize < 1000 ,];

  dat$originalProbNonequivalence_d.2_1nvar <-
    1 - prob.randomizationSuccess(n = dat$originalSampleSize, dNonequivalence = .2, nNuisanceVars = 1);
  dat$originalProbNonequivalence_d.2_10nvar <-
    1 - prob.randomizationSuccess(n = dat$originalSampleSize, dNonequivalence = .2, nNuisanceVars = 10);
  dat$originalProbNonequivalence_d.2_100nvar <-
    1 - prob.randomizationSuccess(n = dat$originalSampleSize, dNonequivalence = .2, nNuisanceVars = 100);
  dat$originalProbNonequivalence_d.5_1nvar <-
    1 - prob.randomizationSuccess(n = dat$originalSampleSize, dNonequivalence = .5, nNuisanceVars = 1);
  dat$originalProbNonequivalence_d.5_10nvar <-
    1 - prob.randomizationSuccess(n = dat$originalSampleSize, dNonequivalence = .5, nNuisanceVars = 10);
  dat$originalProbNonequivalence_d.5_100nvar <-
    1 - prob.randomizationSuccess(n = dat$originalSampleSize, dNonequivalence = .5, nNuisanceVars = 100);

  dat$replicationProbNonequivalence_d.2_1nvar <-
    1 - prob.randomizationSuccess(n = dat$replicationSampleSize, dNonequivalence = .2, nNuisanceVars = 1);
  dat$replicationProbNonequivalence_d.2_10nvar <-
    1 - prob.randomizationSuccess(n = dat$replicationSampleSize, dNonequivalence = .2, nNuisanceVars = 10);
  dat$replicationProbNonequivalence_d.2_100nvar <-
    1 - prob.randomizationSuccess(n = dat$replicationSampleSize, dNonequivalence = .2, nNuisanceVars = 100);
  dat$replicationProbNonequivalence_d.5_1nvar <-
    1 - prob.randomizationSuccess(n = dat$replicationSampleSize, dNonequivalence = .5, nNuisanceVars = 1);
  dat$replicationProbNonequivalence_d.5_10nvar <-
    1 - prob.randomizationSuccess(n = dat$replicationSampleSize, dNonequivalence = .5, nNuisanceVars = 10);
  dat$replicationProbNonequivalence_d.5_100nvar <-
    1 - prob.randomizationSuccess(n = dat$replicationSampleSize, dNonequivalence = .5, nNuisanceVars = 100);

  dat[, grep('ProbNonequivalence', names(dat))] <- lapply(dat[, grep('ProbNonequivalence', names(dat))],
                                                          function(x) return(100*x));
  
  longDatOriginal <- melt(c(dat[, grep('originalProbNonequivalence', names(dat))]));
  names(longDatOriginal) <- c('probability', 'parameters');
  longDatOriginal$n <- rep(dat$originalSampleSize, nrow(longDatOriginal)/ nrow(dat));
  longDatOriginal$d <- gsub('originalProbNonequivalence_d(\\..)_.*',
                            'd = \\1', longDatOriginal$parameters);
  longDatOriginal$nVar <- gsub('originalProbNonequivalence_d.._(.*)nvar',
                               'nVar = \\1', longDatOriginal$parameters);

  longDatReplication <- melt(c(dat[, grep('replicationProbNonequivalence', names(dat))]));
  names(longDatReplication) <- c('probability', 'parameters');
  longDatReplication$n <- rep(dat$replicationSampleSize, nrow(longDatReplication)/ nrow(dat));
  longDatReplication$d <- gsub('replicationProbNonequivalence_d(\\..)_.*',
                            'd = \\1', longDatReplication$parameters);
  longDatReplication$nVar <- gsub('replicationProbNonequivalence_d.._(.*)nvar',
                               'nVar = \\1', longDatReplication$parameters);
  
  ggplot(longDatOriginal, aes(x = nVar,
                              y = probability,
                              group = d,
                              shape = d,
                              color = n)) +
    geom_point(size=5, alpha=.75,
               position=position_jitterdodge(jitter.width = .2,
                                             jitter.height = 2,
                                             dodge.width = .7)) +
    theme_bw(base_size = 20) +
    scale_color_continuous(low="#BBBBBB", high="#000000") +
    scale_x_discrete(labels=c("1",
                              "10",
                              "100")) +
    xlab("Number of nuisance variables") +
    ylab("Probability of nonequivalent groups\nfor at least one nuisance variable");

ggsave(file.path(outputPath, "figure 4 - probability of nonequivalence for original studies.png"), 
       width = 14,
       height = 10,
       type='cairo-png');
 
  ggplot(longDatReplication, aes(x = nVar,
                                 y = probability,
                                 group = d,
                                 shape = d,
                                 color = n)) +
    geom_point(size=5, alpha=.75,
               position=position_jitterdodge(jitter.width = .2,
                                             jitter.height = 2,
                                             dodge.width = .7)) +
    theme_bw(base_size = 20) +
    scale_color_continuous(low="#BBBBBB", high="#000000") +
    scale_x_discrete(labels=c("1",
                              "10",
                              "100")) +
    xlab("Number of nuisance variables") +
    ylab("Probability of nonequivalent groups\nfor at least one nuisance variable");
  
ggsave(file.path(outputPath, "figure 5 - probability of nonequivalence for replications.png"), 
       width = 14,
       height = 10,
       type='cairo-png');
  
  
```


